<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title> UniverseOS WebSSH </title>
    <link href="/static/img/webssh.png" rel="icon" type="image/png">
    <link href="/static/css/public/bootstrap.min.css" rel="stylesheet" type="text/css"/>
    <link href="/static/css/public/xterm.min.css" rel="stylesheet" type="text/css"/>
    <link href="/static/css/public/fullscreen.min.css" rel="stylesheet" type="text/css"/>
    <style>
        .row {
            margin-top: 15px;
            margin-bottom: 10px;
        }

        .container {
            margin-top: 20px;
        }

        .btn {
            margin-top: 15px;
        }

        .btn-danger {
            margin-left: 5px;
        }

        .navbar {
            padding: 0.5rem 1rem; /* 调整 Navbar 的内边距以改变其高度 */
        }

        .nav-link i {
            font-size: 2rem; /* 调整图标大小 */
            margin-right: 20px; /* 在图标之间添加间隙 */
        }

        .nav-link {
            color: #333; /* 改变链接颜色 */
            transition: color 0.3s ease; /* 添加颜色过渡效果 */
        }

        .nav-link:hover {
            color: #007bff; /* 改变鼠标悬停时的链接颜色 */
        }
    </style>
</head>
<body>
<!-- Navbar -->
<nav class="navbar navbar-light bg-light">
    <div class="container-fluid">
        <a class="navbar-brand d-none d-lg-block" href="#">WebSSH</a>
        <div class="d-flex justify-content-end">
            <!-- 主页图标链接 -->
            <a class="nav-link me-2" href="/">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                     class="bi bi-house-door" viewBox="0 0 16 16">
                    <path d="M8.354 1.146a.5.5 0 0 0-.708 0l-6 6A.5.5 0 0 0 1.5 7.5v7a.5.5 0 0 0 .5.5h4.5a.5.5 0 0 0 .5-.5v-4h2v4a.5.5 0 0 0 .5.5H14a.5.5 0 0 0 .5-.5v-7a.5.5 0 0 0-.146-.354L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293zM2.5 14V7.707l5.5-5.5 5.5 5.5V14H10v-4a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5v4z"/>
                </svg>
            </a>
            <!-- 文件夹图标链接 -->
            <a class="nav-link me-2" href="/files">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-folder"
                     viewBox="0 0 16 16">
                    <path d="M.54 3.87.5 3a2 2 0 0 1 2-2h3.672a2 2 0 0 1 1.414.586l.828.828A2 2 0 0 0 9.828 3h3.982a2 2 0 0 1 1.992 2.181l-.637 7A2 2 0 0 1 13.174 14H2.826a2 2 0 0 1-1.991-1.819l-.637-7a1.99 1.99 0 0 1 .342-1.31zM2.19 4a1 1 0 0 0-.996 1.09l.637 7a1 1 0 0 0 .995.91h10.348a1 1 0 0 0 .995-.91l.637-7A1 1 0 0 0 13.81 4H2.19zm4.69-1.707A1 1 0 0 0 6.172 2H2.5a1 1 0 0 0-1 .981l.006.139C1.72 3.042 1.95 3 2.19 3h5.396l-.707-.707z"/>
                </svg>
            </a>
            <!-- Shell图标链接 -->
            <a class="nav-link me-2" href="/webssh/">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                     class="bi bi-terminal" viewBox="0 0 16 16">
                    <path d="M6 9a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3A.5.5 0 0 1 6 9M3.854 4.146a.5.5 0 1 0-.708.708L4.793 6.5 3.146 8.146a.5.5 0 1 0 .708.708l2-2a.5.5 0 0 0 0-.708l-2-2z"/>
                    <path d="M2 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2zm12 1a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1z"/>
                </svg>
            </a>
            <!-- 应用图标链接 -->
            <a class="nav-link me-2" href="/containers">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-boxes"
                     viewBox="0 0 16 16">
                    <path d="M7.752.066a.5.5 0 0 1 .496 0l3.75 2.143a.5.5 0 0 1 .252.434v3.995l3.498 2A.5.5 0 0 1 16 9.07v4.286a.5.5 0 0 1-.252.434l-3.75 2.143a.5.5 0 0 1-.496 0l-3.502-2-3.502 2.001a.5.5 0 0 1-.496 0l-3.75-2.143A.5.5 0 0 1 0 13.357V9.071a.5.5 0 0 1 .252-.434L3.75 6.638V2.643a.5.5 0 0 1 .252-.434L7.752.066ZM4.25 7.504 1.508 9.071l2.742 1.567 2.742-1.567L4.25 7.504ZM7.5 9.933l-2.75 1.571v3.134l2.75-1.571V9.933Zm1 3.134 2.75 1.571v-3.134L8.5 9.933v3.134Zm.508-3.996 2.742 1.567 2.742-1.567-2.742-1.567-2.742 1.567Zm2.242-2.433V3.504L8.5 5.076V8.21l2.75-1.572ZM7.5 8.21V5.076L4.75 3.504v3.134L7.5 8.21ZM5.258 2.643 8 4.21l2.742-1.567L8 1.076 5.258 2.643ZM15 9.933l-2.75 1.571v3.134L15 13.067V9.933ZM3.75 14.638v-3.134L1 9.933v3.134l2.75 1.571Z"/>
                </svg>
            </a>
            <!-- 应用图标链接 -->
            <a class="nav-link me-2" href="/install">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-bag"
                     viewBox="0 0 16 16">
                    <path d="M8 1a2.5 2.5 0 0 1 2.5 2.5V4h-5v-.5A2.5 2.5 0 0 1 8 1m3.5 3v-.5a3.5 3.5 0 1 0-7 0V4H1v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V4zM2 5h12v9a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1z"/>
                </svg>
            </a>
            <!-- 仪表台图标链接 -->
            <a class="nav-link" href="/monitor">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                     class="bi bi-arrow-down-up" viewBox="0 0 16 16">
                    <path fill-rule="evenodd"
                          d="M11.5 15a.5.5 0 0 0 .5-.5V2.707l3.146 3.147a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L11 2.707V14.5a.5.5 0 0 0 .5.5m-7-14a.5.5 0 0 1 .5.5v11.793l3.146-3.147a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4-4a.5.5 0 0 1 .708-.708L4 13.293V1.5a.5.5 0 0 1 .5-.5"/>
                </svg>
            </a>
            <a class="nav-link" href="/logout">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                     class="bi bi-box-arrow-right" viewBox="0 0 16 16">
                    <path fill-rule="evenodd"
                          d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0v2z"/>
                    <path fill-rule="evenodd"
                          d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"/>
                </svg>
            </a>
        </div>
    </div>
</nav>
<!-- Navbar End -->
<div style="background-color: #333; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0;">
    <div id="waiter" style="display: none; transform: scale(1.2);"> 连接中 ...</div>
    <div class="container form-container"
         style="display: none; width: 100%; max-width: 720px; padding: 24px; transform: scale(1.1); background-color: #F8F9FA; border-radius: 10px; box-sizing: border-box; position: relative; left: 50%; transform: translateX(-50%);">
        <form id="connect" action="" method="post" enctype="multipart/form-data"{% if debug %} novalidate{% end %}>
            <div class="row mt-3">
                <div class="col">
                    <label for="Hostname" style="font-weight: bold; margin-bottom: 5px;">域名</label>
                    <input class="form-control" type="text" id="hostname" name="hostname" value="" required
                           style="border: 1px solid #ccc; border-radius: 4px; padding: 10px; font-size: 16px; color: #333; width: 100%; box-sizing: border-box; margin-bottom: 20px;">
                </div>
                <div class="col">
                    <label for="Port" style="font-weight: bold; margin-bottom: 5px;">端口</label>
                    <input class="form-control" type="number" id="port" name="port" placeholder="22" value="" min=1
                           max=65535
                           style="border: 1px solid #ccc; border-radius: 4px; padding: 10px; font-size: 16px; color: #333; width: 100%; box-sizing: border-box; margin-bottom: 20px;">
                </div>
            </div>
            <div class="row mt-3">
                <div class="col">
                    <label for="Username" style="font-weight: bold; margin-bottom: 5px;">用户名</label>
                    <input class="form-control" type="text" id="username" name="username" value="" required
                           style="border: 1px solid #ccc; border-radius: 4px; padding: 10px; font-size: 16px; color: #333; width: 100%; box-sizing: border-box; margin-bottom: 20px;">
                </div>
                <div class="col">
                    <label for="Password" style="font-weight: bold; margin-bottom: 5px;">密码</label>
                    <input class="form-control" type="password" id="password" name="password" value=""
                           style="border: 1px solid #ccc; border-radius: 4px; padding: 10px; font-size: 16px; color: #333; width: 100%; box-sizing: border-box; margin-bottom: 20px;">
                </div>
            </div>
            <div class="row mt-3">
                <div class="col">
                    <label for="Username" style="font-weight: bold; margin-bottom: 5px;">私钥</label>
                    <input class="form-control" type="file" id="privatekey" name="privatekey" value=""
                           style="border: 1px solid #ccc; border-radius: 4px; padding: 10px; font-size: 16px; color: #333; width: 100%; box-sizing: border-box; margin-bottom: 30px; height: 50px;">
                </div>
            </div>
            <div class="row mt-3">
                <div class="col">
                </div>
            </div>
            <input type="hidden" id="term" name="term" value="xterm-256color">
            {% module xsrf_form_html() %}
            <button type="submit" class="btn btn-primary mt-3"
                    style="border: none; border-radius: 4px; padding: 10px 20px; font-size: 16px; color: #fff; cursor: pointer; background-color: #007bff;">
                连接
            </button>
            <button type="reset" class="btn btn-danger mt-3"
                    style="border: none; border-radius: 4px; padding: 10px 20px; font-size: 16px; color: #fff; cursor: pointer; background-color: #dc3545;">
                重置
            </button>
        </form>
    </div>


</body>
<div class="container">
    <div id="status" style="color: red;"></div>
    <div id="terminal"></div>
</div>

<script src="/static/js/public/jquery.min.js"></script>
<script src="/static/js/public/popper.min.js"></script>
<script src="/static/js/public/bootstrap.min.js"></script>
<script src="/static/js/public/xterm.min.js"></script>
<script src="/static/js/public/xterm-addon-fit.min.js"></script>
<script>
    /*jslint browser:true */

    var jQuery;
    var wssh = {};


    (function () {
        // For FormData without getter and setter
        var proto = FormData.prototype,
            data = {};

        if (!proto.get) {
            proto.get = function (name) {
                if (data[name] === undefined) {
                    var input = document.querySelector('input[name="' + name + '"]'),
                        value;
                    if (input) {
                        if (input.type === 'file') {
                            value = input.files[0];
                        } else {
                            value = input.value;
                        }
                        data[name] = value;
                    }
                }
                return data[name];
            };
        }

        if (!proto.set) {
            proto.set = function (name, value) {
                data[name] = value;
            };
        }
    }());


    jQuery(function ($) {
        var status = $('#status'),
            button = $('.btn-primary'),
            form_container = $('.form-container'),
            waiter = $('#waiter'),
            term_type = $('#term'),
            style = {},
            default_title = 'WebSSH',
            title_element = document.querySelector('title'),
            form_id = '#connect',
            debug = document.querySelector(form_id).noValidate,
            custom_font = document.fonts ? document.fonts.values().next().value : undefined,
            default_fonts,
            DISCONNECTED = 0,
            CONNECTING = 1,
            CONNECTED = 2,
            state = DISCONNECTED,
            messages = {1: 'This client is connecting ...', 2: 'This client is already connnected.'},
            key_max_size = 16384,
            fields = ['hostname', 'port', 'username'],
            form_keys = fields.concat(['password', 'totp']),
            opts_keys = ['bgcolor', 'title', 'encoding', 'command', 'term', 'fontsize', 'fontcolor'],
            url_form_data = {},
            url_opts_data = {},
            validated_form_data,
            event_origin,
            hostname_tester = /((^\s*((([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5]))\s*$)|(^\s*((([0-9A-Fa-f]{1,4}:){7}([0-9A-Fa-f]{1,4}|:))|(([0-9A-Fa-f]{1,4}:){6}(:[0-9A-Fa-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){5}(((:[0-9A-Fa-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){4}(((:[0-9A-Fa-f]{1,4}){1,3})|((:[0-9A-Fa-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){3}(((:[0-9A-Fa-f]{1,4}){1,4})|((:[0-9A-Fa-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){2}(((:[0-9A-Fa-f]{1,4}){1,5})|((:[0-9A-Fa-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){1}(((:[0-9A-Fa-f]{1,4}){1,6})|((:[0-9A-Fa-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9A-Fa-f]{1,4}){1,7})|((:[0-9A-Fa-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))(%.+)?\s*$))|(^\s*((?=.{1,255}$)(?=.*[A-Za-z].*)[0-9A-Za-z](?:(?:[0-9A-Za-z]|\b-){0,61}[0-9A-Za-z])?(?:\.[0-9A-Za-z](?:(?:[0-9A-Za-z]|\b-){0,61}[0-9A-Za-z])?)*)\s*$)/;


        function store_items(names, data) {
            var i, name, value;

            for (i = 0; i < names.length; i++) {
                name = names[i];
                value = data.get(name);
                if (value) {
                    window.localStorage.setItem(name, value);
                }
            }
        }


        function restore_items(names) {
            var i, name, value;

            for (i = 0; i < names.length; i++) {
                name = names[i];
                value = window.localStorage.getItem(name);
                if (value) {
                    $('#' + name).val(value);
                }
            }
        }


        function populate_form(data) {
            var names = form_keys.concat(['passphrase']),
                i, name;

            for (i = 0; i < names.length; i++) {
                name = names[i];
                $('#' + name).val(data.get(name));
            }
        }


        function get_object_length(object) {
            return Object.keys(object).length;
        }


        function decode_uri_component(uri) {
            try {
                return decodeURIComponent(uri);
            } catch (e) {
                console.error(e);
            }
            return '';
        }


        function decode_password(encoded) {
            try {
                return window.atob(encoded);
            } catch (e) {
                console.error(e);
            }
            return null;
        }


        function parse_url_data(string, form_keys, opts_keys, form_map, opts_map) {
            var i, pair, key, val,
                arr = string.split('&');

            for (i = 0; i < arr.length; i++) {
                pair = arr[i].split('=');
                key = pair[0].trim().toLowerCase();
                val = pair.slice(1).join('=').trim();

                if (form_keys.indexOf(key) >= 0) {
                    form_map[key] = val;
                } else if (opts_keys.indexOf(key) >= 0) {
                    opts_map[key] = val;
                }
            }

            if (form_map.password) {
                form_map.password = decode_password(form_map.password);
            }
        }


        function parse_xterm_style() {
            var text = $('.xterm-helpers style').text();
            var arr = text.split('xterm-normal-char{width:');
            style.width = parseFloat(arr[1]);
            arr = text.split('div{height:');
            style.height = parseFloat(arr[1]);
        }


        function get_cell_size(term) {
            style.width = term._core._renderService._renderer.dimensions.actualCellWidth;
            style.height = term._core._renderService._renderer.dimensions.actualCellHeight;
        }


        function toggle_fullscreen(term) {
            $('#terminal .terminal').toggleClass('fullscreen');
            term.fitAddon.fit();
        }


        function current_geometry(term) {
            if (!style.width || !style.height) {
                try {
                    get_cell_size(term);
                } catch (TypeError) {
                    parse_xterm_style();
                }
            }

            var cols = parseInt(window.innerWidth / style.width, 10) - 1;
            var rows = parseInt(window.innerHeight / style.height, 10);
            return {'cols': cols, 'rows': rows};
        }


        function resize_terminal(term) {
            var geometry = current_geometry(term);
            term.on_resize(geometry.cols, geometry.rows);
        }


        function set_backgound_color(term, color) {
            term.setOption('theme', {
                background: color
            });
        }

        function set_font_color(term, color) {
            term.setOption('theme', {
                foreground: color
            });
        }

        function custom_font_is_loaded() {
            if (!custom_font) {
                {#console.log('No custom font specified.');#}
            } else {
                console.log('Status of custom font ' + custom_font.family + ': ' + custom_font.status);
                if (custom_font.status === 'loaded') {
                    return true;
                }
                if (custom_font.status === 'unloaded') {
                    return false;
                }
            }
        }

        function update_font_family(term) {
            if (term.font_family_updated) {
                console.log('Already using custom font family');
                return;
            }

            if (!default_fonts) {
                default_fonts = term.getOption('fontFamily');
            }

            if (custom_font_is_loaded()) {
                var new_fonts = custom_font.family + ', ' + default_fonts;
                term.setOption('fontFamily', new_fonts);
                term.font_family_updated = true;
                console.log('Using custom font family ' + new_fonts);
            }
        }


        function reset_font_family(term) {
            if (!term.font_family_updated) {
                console.log('Already using default font family');
                return;
            }

            if (default_fonts) {
                term.setOption('fontFamily', default_fonts);
                term.font_family_updated = false;
                console.log('Using default font family ' + default_fonts);
            }
        }


        function format_geometry(cols, rows) {
            return JSON.stringify({'cols': cols, 'rows': rows});
        }


        function read_as_text_with_decoder(file, callback, decoder) {
            var reader = new window.FileReader();

            if (decoder === undefined) {
                decoder = new window.TextDecoder('utf-8', {'fatal': true});
            }

            reader.onload = function () {
                var text;
                try {
                    text = decoder.decode(reader.result);
                } catch (TypeError) {
                    console.log('Decoding error happened.');
                } finally {
                    if (callback) {
                        callback(text);
                    }
                }
            };

            reader.onerror = function (e) {
                console.error(e);
            };

            reader.readAsArrayBuffer(file);
        }


        function read_as_text_with_encoding(file, callback, encoding) {
            var reader = new window.FileReader();

            if (encoding === undefined) {
                encoding = 'utf-8';
            }

            reader.onload = function () {
                if (callback) {
                    callback(reader.result);
                }
            };

            reader.onerror = function (e) {
                console.error(e);
            };

            reader.readAsText(file, encoding);
        }


        function read_file_as_text(file, callback, decoder) {
            if (!window.TextDecoder) {
                read_as_text_with_encoding(file, callback, decoder);
            } else {
                read_as_text_with_decoder(file, callback, decoder);
            }
        }


        function reset_wssh() {
            var name;

            for (name in wssh) {
                if (wssh.hasOwnProperty(name) && name !== 'connect') {
                    delete wssh[name];
                }
            }
        }


        function log_status(text, to_populate) {
            alert(text);
            status.html(text.split('\n').join('<br/>'));

            if (to_populate && validated_form_data) {
                populate_form(validated_form_data);
                validated_form_data = undefined;
            }

            if (waiter.css('display') !== 'none') {
                waiter.hide();
            }

            if (form_container.css('display') === 'none') {
                form_container.show();
            }
        }


        function ajax_complete_callback(resp) {
            button.prop('disabled', false);

            if (resp.status !== 200) {
                log_status(resp.status + ': ' + resp.statusText, true);
                state = DISCONNECTED;
                return;
            }

            var msg = resp.responseJSON;
            if (!msg.id) {
                log_status(msg.status, true);
                state = DISCONNECTED;
                return;
            }

            var ws_url = window.location.href.split(/\?|#/, 1)[0].replace('http', 'ws'),
                join = (ws_url[ws_url.length - 1] === '/' ? '' : '/'),
                url = ws_url + join + 'ws?id=' + msg.id,
                sock = new window.WebSocket(url),
                encoding = 'utf-8',
                decoder = window.TextDecoder ? new window.TextDecoder(encoding) : encoding,
                terminal = document.getElementById('terminal'),
                termOptions = {
                    cursorBlink: true,
                    theme: {
                        background: url_opts_data.bgcolor || 'black',
                        foreground: url_opts_data.fontcolor || 'white'
                    }
                };

            if (url_opts_data.fontsize) {
                var fontsize = window.parseInt(url_opts_data.fontsize);
                if (fontsize && fontsize > 0) {
                    termOptions.fontSize = fontsize;
                }
            }

            var term = new window.Terminal(termOptions);

            term.fitAddon = new window.FitAddon.FitAddon();
            term.loadAddon(term.fitAddon);

            console.log(url);
            if (!msg.encoding) {
                console.log('Unable to detect the default encoding of your server');
                msg.encoding = encoding;
            } else {
                console.log('The deault encoding of your server is ' + msg.encoding);
            }

            function term_write(text) {
                if (term) {
                    term.write(text);
                    if (!term.resized) {
                        resize_terminal(term);
                        term.resized = true;
                    }
                }
            }

            function set_encoding(new_encoding) {
                // for console use
                if (!new_encoding) {
                    console.log('An encoding is required');
                    return;
                }

                if (!window.TextDecoder) {
                    decoder = new_encoding;
                    encoding = decoder;
                    console.log('Set encoding to ' + encoding);
                } else {
                    try {
                        decoder = new window.TextDecoder(new_encoding);
                        encoding = decoder.encoding;
                        console.log('Set encoding to ' + encoding);
                    } catch (RangeError) {
                        console.log('Unknown encoding ' + new_encoding);
                        return false;
                    }
                }
            }

            wssh.set_encoding = set_encoding;

            if (url_opts_data.encoding) {
                if (set_encoding(url_opts_data.encoding) === false) {
                    set_encoding(msg.encoding);
                }
            } else {
                set_encoding(msg.encoding);
            }


            wssh.geometry = function () {
                // for console use
                var geometry = current_geometry(term);
                console.log('Current window geometry: ' + JSON.stringify(geometry));
            };

            wssh.send = function (data) {
                // for console use
                if (!sock) {
                    console.log('Websocket was already closed');
                    return;
                }

                if (typeof data !== 'string') {
                    console.log('Only string is allowed');
                    return;
                }

                try {
                    JSON.parse(data);
                    sock.send(data);
                } catch (SyntaxError) {
                    data = data.trim() + '\r';
                    sock.send(JSON.stringify({'data': data}));
                }
            };

            wssh.reset_encoding = function () {
                // for console use
                if (encoding === msg.encoding) {
                    console.log('Already reset to ' + msg.encoding);
                } else {
                    set_encoding(msg.encoding);
                }
            };

            wssh.resize = function (cols, rows) {
                // for console use
                if (term === undefined) {
                    console.log('Terminal was already destroryed');
                    return;
                }

                var valid_args = false;

                if (cols > 0 && rows > 0) {
                    var geometry = current_geometry(term);
                    if (cols <= geometry.cols && rows <= geometry.rows) {
                        valid_args = true;
                    }
                }

                if (!valid_args) {
                    console.log('Unable to resize terminal to geometry: ' + format_geometry(cols, rows));
                } else {
                    term.on_resize(cols, rows);
                }
            };

            wssh.set_bgcolor = function (color) {
                set_backgound_color(term, color);
            };

            wssh.set_fontcolor = function (color) {
                set_font_color(term, color);
            };

            wssh.custom_font = function () {
                update_font_family(term);
            };

            wssh.default_font = function () {
                reset_font_family(term);
            };

            term.on_resize = function (cols, rows) {
                if (cols !== this.cols || rows !== this.rows) {
                    console.log('Resizing terminal to geometry: ' + format_geometry(cols, rows));
                    this.resize(cols, rows);
                    sock.send(JSON.stringify({'resize': [cols, rows]}));
                }
            };

            term.onData(function (data) {
                // console.log(data);
                sock.send(JSON.stringify({'data': data}));
            });

            sock.onopen = function () {
                term.open(terminal);
                toggle_fullscreen(term);
                update_font_family(term);
                term.focus();
                state = CONNECTED;
                title_element.text = url_opts_data.title || default_title;
                if (url_opts_data.command) {
                    setTimeout(function () {
                        sock.send(JSON.stringify({'data': url_opts_data.command + '\r'}));
                    }, 500);
                }
            };

            sock.onmessage = function (msg) {
                read_file_as_text(msg.data, term_write, decoder);
            };

            sock.onerror = function (e) {
                console.error(e);
            };

            sock.onclose = function (e) {
                term.dispose();
                term = undefined;
                sock = undefined;
                reset_wssh();
                log_status(e.reason, true);
                state = DISCONNECTED;
                default_title = 'WebSSH';
                title_element.text = default_title;
            };

            $(window).resize(function () {
                if (term) {
                    resize_terminal(term);
                }
            });
        }


        function wrap_object(opts) {
            var obj = {};

            obj.get = function (attr) {
                return opts[attr] || '';
            };

            obj.set = function (attr, val) {
                opts[attr] = val;
            };

            return obj;
        }


        function clean_data(data) {
            var i, attr, val;
            var attrs = form_keys.concat(['privatekey', 'passphrase']);

            for (i = 0; i < attrs.length; i++) {
                attr = attrs[i];
                val = data.get(attr);
                if (typeof val === 'string') {
                    data.set(attr, val.trim());
                }
            }
        }


        function validate_form_data(data) {
            clean_data(data);

            var hostname = data.get('hostname'),
                port = data.get('port'),
                username = data.get('username'),
                pk = data.get('privatekey'),
                result = {
                    valid: false,
                    data: data,
                    title: ''
                },
                errors = [], size;

            if (!hostname) {
                errors.push('Value of hostname is required.');
            } else {
                if (!hostname_tester.test(hostname)) {
                    errors.push('主机名错误: ' + hostname);
                }
            }

            if (!port) {
                port = 22;
            } else {
                if (!(port > 0 && port <= 65535)) {
                    errors.push('端口错误: ' + port);
                }
            }

            if (!username) {
                errors.push('用户名的值是必需的');
            }

            if (pk) {
                size = pk.size || pk.length;
                if (size > key_max_size) {
                    errors.push('密钥错误: ' + pk.name || '');
                }
            }

            if (!errors.length || debug) {
                result.valid = true;
                result.title = username + '@' + hostname + ':' + port;
            }
            result.errors = errors;

            return result;
        }

        // Fix empty input file ajax submission error for safari 11.x
        function disable_file_inputs(inputs) {
            var i, input;

            for (i = 0; i < inputs.length; i++) {
                input = inputs[i];
                if (input.files.length === 0) {
                    input.setAttribute('disabled', '');
                }
            }
        }


        function enable_file_inputs(inputs) {
            var i;

            for (i = 0; i < inputs.length; i++) {
                inputs[i].removeAttribute('disabled');
            }
        }


        function connect_without_options() {
            // use data from the form
            var form = document.querySelector(form_id),
                inputs = form.querySelectorAll('input[type="file"]'),
                url = form.action,
                data, pk;

            disable_file_inputs(inputs);
            data = new FormData(form);
            pk = data.get('privatekey');
            enable_file_inputs(inputs);

            function ajax_post() {
                status.text('');
                button.prop('disabled', true);

                $.ajax({
                    url: url,
                    type: 'post',
                    data: data,
                    complete: ajax_complete_callback,
                    cache: false,
                    contentType: false,
                    processData: false
                });
            }

            var result = validate_form_data(data);
            if (!result.valid) {
                log_status(result.errors.join('\n'));
                return;
            }

            if (pk && pk.size && !debug) {
                read_file_as_text(pk, function (text) {
                    if (text === undefined) {
                        log_status('密钥错误: ' + pk.name);
                    } else {
                        ajax_post();
                    }
                });
            } else {
                ajax_post();
            }

            return result;
        }


        function connect_with_options(data) {
            // use data from the arguments
            var form = document.querySelector(form_id),
                url = data.url || form.action,
                _xsrf = form.querySelector('input[name="_xsrf"]');

            var result = validate_form_data(wrap_object(data));
            if (!result.valid) {
                log_status(result.errors.join('\n'));
                return;
            }

            data.term = term_type.val();
            data._xsrf = _xsrf.value;
            if (event_origin) {
                data._origin = event_origin;
            }

            status.text('');
            button.prop('disabled', true);

            $.ajax({
                url: url,
                type: 'post',
                data: data,
                complete: ajax_complete_callback
            });

            return result;
        }


        function connect(hostname, port, username, password, privatekey, passphrase, totp) {
            // for console use
            var result, opts;

            if (state !== DISCONNECTED) {
                console.log(messages[state]);
                return;
            }

            if (hostname === undefined) {
                result = connect_without_options();
            } else {
                if (typeof hostname === 'string') {
                    opts = {
                        hostname: hostname,
                        port: port,
                        username: username,
                        password: password,
                        privatekey: privatekey,
                        passphrase: passphrase,
                        totp: totp
                    };
                } else {
                    opts = hostname;
                }

                result = connect_with_options(opts);
            }

            if (result) {
                state = CONNECTING;
                default_title = result.title;
                if (hostname) {
                    validated_form_data = result.data;
                }
                store_items(fields, result.data);
            }
        }

        wssh.connect = connect;

        $(form_id).submit(function (event) {
            event.preventDefault();
            connect();
        });


        function cross_origin_connect(event) {
            console.log(event.origin);
            var prop = 'connect',
                args;

            try {
                args = JSON.parse(event.data);
            } catch (SyntaxError) {
                args = event.data.split('|');
            }

            if (!Array.isArray(args)) {
                args = [args];
            }

            try {
                event_origin = event.origin;
                wssh[prop].apply(wssh, args);
            } finally {
                event_origin = undefined;
            }
        }

        window.addEventListener('message', cross_origin_connect, false);

        if (document.fonts) {
            document.fonts.ready.then(
                function () {
                    if (custom_font_is_loaded() === false) {
                        document.body.style.fontFamily = custom_font.family;
                    }
                }
            );
        }


        parse_url_data(
            decode_uri_component(window.location.search.substring(1)) + '&' + decode_uri_component(window.location.hash.substring(1)),
            form_keys, opts_keys, url_form_data, url_opts_data
        );
        // console.log(url_form_data);
        // console.log(url_opts_data);

        if (url_opts_data.term) {
            term_type.val(url_opts_data.term);
        }

        if (url_form_data.password === null) {
            log_status('Password via url must be encoded in base64.');
        } else {
            if (get_object_length(url_form_data)) {
                waiter.show();
                connect(url_form_data);
            } else {
                restore_items(fields);
                form_container.show();
            }
        }

    });
</script>
</div>
</body>
</html>
